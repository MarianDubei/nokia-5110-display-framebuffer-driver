#include <linux/module.h>
#include <linux/init.h>
#include <linux/kernel.h>
#include <linux/types.h>
#include <linux/cdev.h>
#include <linux/fb.h>
#include <linux/uaccess.h>
#include <linux/gpio.h>
#include <linux/fs.h>
#include <asm/uaccess.h>

#define DEVICE_NAME     "nokia5110fb"
#define BUFSIZE 504
#define LCDWIDTH 84
#define LCDHEIGHT 48

#define PCD8544_POWERDOWN 0x04
#define PCD8544_ENTRYMODE 0x02
#define PCD8544_EXTENDEDINSTRUCTION 0x01

#define PCD8544_DISPLAYBLANK 0x0
#define PCD8544_DISPLAYNORMAL 0x4
#define PCD8544_DISPLAYALLON 0x1
#define PCD8544_DISPLAYINVERTED 0x5

// H = 0
#define PCD8544_FUNCTIONSET 0x20
#define PCD8544_DISPLAYCONTROL 0x08
#define PCD8544_SETYADDR 0x40
#define PCD8544_SETXADDR 0x80

// H = 1
#define PCD8544_SETTEMP 0x04
#define PCD8544_SETBIAS 0x10
#define PCD8544_SETVOP 0x80

// initial image
char pcd8544_buffer[] = {
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xF8 , 0xF8 , 0xFC , 0xAE , 0x0E , 0x0E , 0x06 , 0x0E , 0x06,
        0xCE , 0x86 , 0x8E , 0x0E , 0x0E , 0x1C , 0xB8 , 0xF0 , 0xF8 , 0x78 , 0x38 , 0x1E , 0x0E , 0x8E , 0x8E , 0xC6,
        0x0E , 0x06 , 0x0E , 0x06 , 0x0E , 0x9E , 0xFE , 0xFC , 0xF8 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x03 , 0x0F , 0x0F , 0xFE,
        0xF8 , 0xF0 , 0x60 , 0x60 , 0xE0 , 0xE1 , 0xE3 , 0xF7 , 0x7E , 0x3E , 0x1E , 0x1F , 0x1F , 0x1F , 0x3E , 0x7E,
        0xFB , 0xF3 , 0xE1 , 0xE0 , 0x60 , 0x70 , 0xF0 , 0xF8 , 0xBE , 0x1F , 0x0F , 0x07 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0xC0,
        0xE0 , 0xFC , 0xFE , 0xFF , 0xF3 , 0x38 , 0x38 , 0x0C , 0x0E , 0x0F , 0x0F , 0x0F , 0x0E , 0x3C , 0x38 , 0xF8,
        0xF8 , 0x38 , 0x3C , 0x0E , 0x0F , 0x0F , 0x0F , 0x0E , 0x0C , 0x38 , 0x38 , 0xF3 , 0xFF , 0xFF , 0xF8 , 0xE0,
        0x80 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x7F , 0xFF , 0xE7 , 0xC3 , 0xC1 , 0xE0 , 0xFF , 0xFF , 0x78 , 0xE0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xE0,
        0x60 , 0x78 , 0x38 , 0x3F , 0x3F , 0x38 , 0x38 , 0x60 , 0x60 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xE0 , 0xF8 , 0x7F,
        0xFF , 0xE0 , 0xC1 , 0xC3 , 0xE7 , 0x7F , 0x3E , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x03 , 0x0F , 0x7F , 0xFF , 0xF1 , 0xE0 , 0xC0 , 0x80 , 0x01,
        0x03 , 0x9F , 0xFF , 0xF0 , 0xE0 , 0xE0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xC0 , 0xE0 , 0xE0 , 0xF0 , 0xFF , 0x9F,
        0x03 , 0x01 , 0x80 , 0xC0 , 0xE0 , 0xF1 , 0x7F , 0x1F , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x01,
        0x03 , 0x03 , 0x07 , 0x07 , 0x0F , 0x1F , 0x1F , 0x3F , 0x3B , 0x71 , 0x60 , 0x60 , 0x60 , 0x60 , 0x60 , 0x71,
        0x3B , 0x1F , 0x0F , 0x0F , 0x0F , 0x07 , 0x03 , 0x03 , 0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00,
        0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00
};

int buf_counter = 0;


const int RST = 25;
const int CE = 8;
const int DC = 23;
const int DIN = 10;
const int CLK = 11;
const int BL = 24;

static int nokia5110fb_init(void);
static void nokia5110fb_exit(void);

static struct fb_info nokia5110fb_info;

static struct fb_var_screeninfo nokia5110fb_var = {
        .xres =		84,
        .yres =		48,
        .xres_virtual =	84,
        .yres_virtual =	48,
        .bits_per_pixel = 1,
        .activate =	FB_ACTIVATE_NOW,
        .height =	-1,
        .width =	-1,
        .vmode =	FB_VMODE_NONINTERLACED,
};

static struct fb_fix_screeninfo nokia5110fb_fix = {
        .id =		"Nokia 5110",
        .smem_len =	(84*6),
        .type =		FB_TYPE_PACKED_PIXELS,
        .visual =	FB_VISUAL_PSEUDOCOLOR,
        .line_length =	84,
};


//
// Display Control Functions Section
//

void shiftOut(int val)
{
    int i;
    int j;
    for (i = 0; i < 8; i++)  {
        gpio_set_value(DIN, !!(val & (1 << (7 - i))));

        gpio_set_value(CLK, 1);
        for (j = 400; j > 0; j--);
        gpio_set_value(CLK, 0);
    }
}

void LCDspiwrite(int c)
{
    gpio_set_value(CE, 0);
    shiftOut(c);
    gpio_set_value(CE, 1);
}

void LCDcommand(int c)
{
    gpio_set_value( DC, 0);
    LCDspiwrite(c);
}

void LCDdata(int c)
{
    gpio_set_value(DC, 1);
    LCDspiwrite(c);
}

void LCDdisplay(void)
{
    int col, maxcol, p;

    for(p = 0; p < 6; p++)
    {
        LCDcommand(PCD8544_SETYADDR | p);
        // start at the beginning of the row
        col = 0;
        maxcol = LCDWIDTH-1;
        LCDcommand(PCD8544_SETXADDR | col);
        for(; col <= maxcol; col++) {
            //uart_putw_dec(col);
            //uart_putchar(' ');
            LCDdata(pcd8544_buffer[(LCDWIDTH*p)+col]);
        }
    }
    LCDcommand(PCD8544_SETYADDR );

}

void LCDshowbuffer(void)
{
    LCDdisplay();
}

//
// Class Attributes section
//
static ssize_t display_buffer_show(struct class *cls, struct class_attribute *attr, char *buf){
    return sprintf(buf, "%s\n", pcd8544_buffer+'\0');
};
static ssize_t display_buffer_store(struct class *cls, struct class_attribute *attr, const char *buf, size_t count){
    printk(KERN_INFO "input buf  %s\n", buf);
    if (count > 1) {
        pcd8544_buffer[buf_counter] = buf[0];
        buf_counter += 1;
    } else {
        buf_counter = 0;
    }
    LCDshowbuffer();
    return 1;
};
static CLASS_ATTR_RW(display_buffer);
static struct attribute *class_attr_attrs[] = { &class_attr_display_buffer.attr, NULL };
ATTRIBUTE_GROUPS(class_attr);

static struct class nokia5100_class = {
        .name = DEVICE_NAME,
        .owner = THIS_MODULE,
        .class_groups = class_attr_groups,
};


//
// Device Functions Section
//

void nokia5110_setup(void)
{
    gpio_direction_output(RST, 0);
    gpio_direction_output(CE, 0);
    gpio_direction_output(BL, 0);
    gpio_direction_output(DC, 0);
    gpio_direction_output(DIN, 0);
    gpio_direction_output(CLK, 0);
    gpio_set_value(RST, 0);
    int j;
    for (j = 400; j > 0; j--);
    gpio_set_value(RST, 1);
    gpio_set_value(CE, 1);
    gpio_set_value(BL, 1);

    // get into the EXTENDED mode!
    LCDcommand(PCD8544_FUNCTIONSET | PCD8544_EXTENDEDINSTRUCTION );

    // LCD bias select (4 is optimal?)
    LCDcommand(PCD8544_SETBIAS | 0x4);

    // set VOP
    int contrast = 55;
    if (contrast > 0x7f)
        contrast = 0x7f;

    LCDcommand( PCD8544_SETVOP | contrast); // Experimentally determined

    // normal mode
    LCDcommand(PCD8544_FUNCTIONSET);

    // Set display to Normal
    LCDcommand(PCD8544_DISPLAYCONTROL | PCD8544_DISPLAYNORMAL);

    // set up a bounding box for screen updates

    LCDshowbuffer();
}

static int nokia5110fb_read(struct fb_info *nokia5110_fb_info, char *buf, size_t count, loff_t *ppos) {

    int retval;
    char byte;

    for (retval = 0; retval < 84*6; ++retval) {
        byte = *(pcd8544_buffer+retval);
        if (put_user(byte, buf + retval))
            break;
    }
    return retval;
}

static ssize_t nokia5110fb_write(struct fb_info *nokia5110_fb_info, const char *buf, size_t count, loff_t *ppos) {

    memset(pcd8544_buffer, 0, BUFSIZE);
    if (copy_from_user(pcd8544_buffer, buf, count) != 0)
        return -EFAULT;
    pcd8544_buffer[count] = '\0';

    LCDdisplay();
    ppos += count;
    return count;
}



static const struct fb_ops nokia5110fb_ops = {
        .owner = THIS_MODULE,
        .fb_read = nokia5110fb_read, // read operation
        .fb_write = nokia5110fb_write, // write operation
};

static int __init nokia5110fb_init(void)
{
    nokia5110_setup();

    nokia5110fb_info.fbops = &nokia5110fb_ops;
    nokia5110fb_info.screen_base = (char *)nokia5110fb_fix.smem_start;
    nokia5110fb_info.var = nokia5110fb_var;
    nokia5110fb_info.fix = nokia5110fb_fix;
    nokia5110fb_info.flags = FBINFO_DEFAULT;
    fb_alloc_cmap(&nokia5110fb_info.cmap, 504, 0);
    if (register_framebuffer(&nokia5110fb_info) < 0)
        return 1;
    if (class_register(&nokia5100_class) < 0)
    {
        printk(KERN_DEBUG "Cannot create class %s\n", DEVICE_NAME);
        unregister_framebuffer(&nokia5110fb_info);
        return -EINVAL;
    }
    printk(KERN_INFO "[NOKIA5110FB] - Nokia 5110 Display Framebuffer Driver initialized\n");
    return 0;
}

static void __exit nokia5110fb_exit(void)
{
    unregister_framebuffer(&nokia5110fb_info);
    class_destroy(&nokia5100_class);
    printk(KERN_INFO "[NOKIA5110FB] - Nokia 5110 Display Framebuffer Driver removed\n");
}

module_init(nokia5110fb_init);
module_exit(nokia5110fb_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Dubei Marian, Rumezhak Taras");
MODULE_DESCRIPTION("Nokia 5110 Display Framebuffer Driver - Linux device driver for Raspberry Pi");
